# 飞行敌人状态实现说明

## 实现概述

本文档记录飞行敌人（Air Enemy）的Idle和Patrol状态的实现细节。

**实现时间**: 2024-12-23  
**实现状态**: 73 已完成基础功能（不包含动画播放）

## 已实现的状态

### 1. AirEnemyIdleState（飞行待机状态）

**文件位置**: `Scripts/5_EnemyStateMachine/States/AirEnemyIdleState.cs`

#### 核心功能

1. **悬浮效果**
   - 垂直方向：正弦波上下浮动（可配置幅度和速度）
   - 水平方向：余弦波左右漂移（产生自然的悬浮感）
   - 随机初始相位：避免所有敌人同步移动

2. **高度控制**
   - `minFlightHeight`: 最低飞行高度（默认2米）
   - `maxFlightHeight`: 最高飞行高度（默认8米）
   - 初始化时自动调整到有效高度范围

3. **玩家检测**
   - 定期扫描玩家（可配置扫描间隔）
   - 视线遮挡检测（使用Raycast）
   - 检测到玩家后自动面向玩家

4. **物理特性**
   - 重力缩放设为0（不受重力影响）
   - 支持Rigidbody2D物理移动
   - 也支持直接Transform移动

5. **状态转换**
   - 检测到玩家 → Chase（如果存在）或 Patrol
   - 待机超时 → Patrol
   - 超时时间可配置（默认5秒）

#### 可配置参数

```csharp
[Header("待机状态设置")]
internal float idleTimeout = 5f;              // 待机超时时间
internal float detectionRange = 7f;           // 玩家检测范围
private float scanInterval = 0.5f;            // 扫描间隔
internal LayerMask obstacleLayer = -1;        // 障碍物层级

[Header("悬浮效果")]
private bool enableHoverEffect = true;        // 启用悬浮效果
private float hoverAmplitude = 0.3f;          // 悬浮幅度
private float hoverSpeed = 1.5f;              // 悬浮速度
private float hoverDriftAmplitude = 0.15f;    // 水平漂移幅度
private float hoverDriftSpeed = 0.8f;         // 水平漂移速度

[Header("高度控制")]
internal float minFlightHeight = 2f;          // 最低飞行高度
internal float maxFlightHeight = 8f;          // 最高飞行高度
```

#### 调试功能

- Gizmos显示检测范围（黄色/红色球体）
- 显示原始悬浮位置（青色立方体）
- 显示悬浮范围框
- 显示高度限制线
- 显示到玩家的连线

---

### 2. AirEnemyPatrolState（飞行巡逻状态）

**文件位置**: `Scripts/5_EnemyStateMachine/States/AirEnemyPatrolState.cs`

#### 核心功能

1. **三种巡逻模式**

   **模式1: RandomWaypoint（随机路径点）**
   - 在起始位置周围生成随机3D路径点
   - 到达路径点后暂停，然后生成新路径点
   - 支持X和Y轴自由移动

   **模式2: Circular（圆形巡逻）**
   - 围绕起始位置做圆周运动
   - 圆形半径随机生成
   - 遇到障碍物时反向旋转

   **模式3: HorizontalOnly（仅水平巡逻）**
   - 只在水平方向移动
   - 保持当前高度不变
   - 适合走廊或平台场景

2. **障碍物检测**
   - 前方障碍物射线检测
   - 检测到障碍物时重新生成路径点
   - 可配置检测距离

3. **暂停机制**
   - 到达路径点后暂停
   - 暂停时保持悬浮效果（轻微上下浮动）
   - 暂停结束后生成新路径点

4. **玩家检测**
   - 巡逻过程中持续扫描玩家
   - 视线遮挡判定
   - 检测到玩家立即转换到Chase状态

5. **高度限制**
   - 所有路径点都限制在有效高度范围内
   - 防止飞行敌人飞出场景

#### 可配置参数

```csharp
[Header("巡逻移动设置")]
internal float patrolSpeed = 2.5f;            // 巡逻移动速度
internal float patrolDuration = 10f;          // 巡逻持续时间
internal float detectionRange = 7f;           // 玩家检测范围

[Header("飞行路径设置")]
internal float maxPatrolDistance = 6f;        // 最大巡逻距离
internal float verticalPatrolRange = 3f;      // 垂直巡逻范围
internal float minFlightHeight = 2f;          // 最低飞行高度
internal float maxFlightHeight = 8f;          // 最高飞行高度

[Header("障碍物检测")]
internal LayerMask obstacleLayer = -1;        // 障碍物层级
internal float obstacleDetectionDistance = 1.5f; // 障碍物检测距离

[Header("巡逻模式")]
internal PatrolMode patrolMode = PatrolMode.RandomWaypoint;
internal float waypointReachThreshold = 0.5f; // 到达路径点的阈值
```

#### 巡逻模式枚举

```csharp
public enum PatrolMode
{
    RandomWaypoint,  // 随机路径点模式
    Circular,        // 圆形巡逻
    HorizontalOnly   // 仅水平巡逻
}
```

#### 调试功能

- Gizmos显示检测范围
- 显示巡逻范围（青色球体）
- 显示当前路径点和连线
- 显示圆形巡逻路径
- 显示移动方向箭头
- 显示到玩家的连线

---

## 与地面敌人的主要区别

| 特性 | 地面敌人 | 飞行敌人 |
|------|---------|---------|
| **重力** | 受重力影响 | 不受重力（gravityScale = 0） |
| **移动维度** | 仅X轴（水平） | X+Y轴（3D空间） |
| **地面检测** | 需要检测地面/墙壁/边缘 | 不需要地面检测 |
| **待机效果** | 轻微左右摆动 | 3D悬浮（上下+左右） |
| **巡逻模式** | 左右往返 | 随机路径点/圆形/水平 |
| **高度控制** | 无 | 有最低/最高飞行高度限制 |
| **障碍物处理** | 转向 | 重新生成路径点 |

---

## 使用方法

### 在GenericEnemyController中集成

需要在`GenericEnemyController.cs`中添加工厂方法：

```csharp
private IEnemyState CreateAirIdleState()
{
    var state = new AirEnemyIdleState();
    // 配置参数...
    return state;
}

private IEnemyState CreateAirPatrolState()
{
    var state = new AirEnemyPatrolState();
    // 配置参数...
    return state;
}
```

并在`CreateStateInstance`中添加对应的case。

### 创建专用的飞行敌人控制器

建议创建`AirEnemyController`继承自`EnemyController`，专门处理飞行敌人的特性：
- 初始化时设置`gravityScale = 0`
- 注册飞行专用状态
- 实现飞行特有的移动逻辑

---

## 未实现的功能

1. **动画播放**
   - 当前使用颜色变化代替动画
   - 需要后续接入Animator

2. **Chase状态**
   - 飞行追击状态尚未实现
   - 需要3D空间追踪逻辑

3. **Attack状态**
   - 飞行攻击状态尚未实现
   - 可能需要俯冲攻击或远程攻击

4. **Hurt/Death状态**
   - 受伤和死亡状态尚未实现
   - 需要坠落效果

---

## 测试建议

1. **待机状态测试**
   - 验证悬浮效果是否自然
   - 检查高度限制是否生效
   - 测试玩家检测和视线遮挡

2. **巡逻状态测试**
   - 测试三种巡逻模式
   - 验证障碍物检测
   - 检查路径点生成是否合理
   - 测试暂停机制

3. **状态转换测试**
   - Idle 62 Patrol 循环
   - 玩家检测触发转换
   - 超时转换

4. **边界测试**
   - 测试高度限制边界
   - 测试巡逻距离限制
   - 测试障碍物边界

---

## 性能考虑

1. **射线检测频率**
   - 玩家扫描间隔：0.4-0.5秒
   - 障碍物检测：每帧（仅在移动时）

2. **物理计算**
   - 优先使用Rigidbody2D
   - 悬浮效果使用平滑插值

3. **路径点生成**
   - 仅在到达路径点时生成新点
   - 避免频繁计算

---

## 后续改进方向

1. **路径优化**
   - 实现A*寻路避开障碍物
   - 添加路径平滑

2. **行为多样性**
   - 添加俯冲攻击
   - 添加盘旋行为
   - 添加编队飞行

3. **AI增强**
   - 预测玩家位置
   - 保持安全距离
   - 协同攻击

4. **视觉效果**
   - 飞行粒子效果
   - 翅膀扇动动画
   - 阴影投射

---

## 相关文件

- `AirEnemyIdleState.cs` - 飞行待机状态
- `AirEnemyPatrolState.cs` - 飞行巡逻状态
- `EnemyStateBase.cs` - 状态基类
- `EnemyController.cs` - 控制器抽象基类
- `GenericEnemyController.cs` - 通用控制器（需要扩展）

---

## 版本历史

- **v1.0** (2024-12-23): 初始实现，完成Idle和Patrol基础功能
