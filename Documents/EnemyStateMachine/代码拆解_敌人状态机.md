# 敌人状态机 代码拆解文档

本文档逐文件剖析当前实现，说明职责、调用关系、易错点与扩展点。

## 目录结构

```text
Assets/
└── Scripts/5_EnemyStateMachine/
    ├── EnemyStateMachine.cs           # 状态机核心：注册/切换/Update/历史
    ├── IEnemyState.cs                 # 状态接口
    ├── EnemyStateBase.cs              # 状态基类：模板方法+工具函数
    ├── EnemyController.cs             # 敌人控制器抽象：对接生命周期与接口
    ├── GenericEnemyController.cs      # 通用控制器：工厂/检测/Gizmos
    └── States/
        ├── GroundEnemyIdleState.cs    # 地面待机：扫描玩家/微动/超时转巡逻
        ├── GroundEnemyPatrolState.cs  # 地面巡逻：移动-暂停交替/扫描玩家
        ├── GroundEnemyChaseState.cs   # 地面追击：追踪玩家/墙壁边缘检测
        ├── GroundEnemyAttackState.cs  # 地面攻击：攻击框架/冷却/范围转换
        ├── AirEnemyPatrolState.cs     # 飞行巡逻：3D空间移动/多种巡逻模式
        ├── AirEnemyChaseState.cs      # 飞行追击：多种追击模式/障碍物避让
        └── AirEnemyAttackState.cs     # 飞行攻击：俯冲/远程/掠过攻击模式
```

## 1) EnemyStateMachine.cs

- 维护 `states` 字典与 `currentState`，owner 为 `EnemyController`。
- `TransitionTo/ForceTransitionTo`：退出旧状态 -> 切入新状态 -> 记录历史。
- `Update/FixedUpdate`：委托到当前状态。
- 便于调试：`CurrentStateName`、`GetAllStateNames()`、历史记录等。

## 2) IEnemyState.cs / EnemyStateBase.cs

- 接口规定状态生命周期与转换授权 `CanTransitionTo`。
- 基类封装：
  - 进入/更新/物理/退出的模板流程与计时器。
  - 子类实现 `UpdateState` 与 `CheckTransitionConditions`。
  - 常用工具：超时、百分比进度、时间窗口等。

## 3) EnemyController.cs

- 抽象基类：
  - 在 `Awake` 初始化状态机并调用 `RegisterStates()`。
  - 在 `Start` 进入 `Idle`（若存在）。
  - 在 `Update/FixedUpdate` 推进状态机。
- 抽象接口由具体敌人实现：动画、移动、朝向、攻击、玩家检测与目标获取。
- 提供大量可重写工具方法（击退、音效、物理检测、Gizmos等）。

## 4) GenericEnemyController.cs

- 作用：开箱即用的通用敌人控制器，支持地面敌人和飞行敌人。
- 核心点：
  - Inspector 可配置 `enabledStates` 与 `initialState`。
  - `enemyType` 枚举区分 `GroundEnemy`/`FlyingEnemy`/`BossEnemy`。
  - `RegisterStates()` 遍历配置，工厂方法根据敌人类型创建对应状态。
  - 工厂：`CreateIdleState/PatrolState/ChaseState/AttackState` 均已实现。
  - 物理检测：`CheckGroundCollision/CheckWallCollision/CheckPlatformEdge` 已实现。
  - Gizmos：检测范围/巡逻范围/到玩家连线等。

## 5) GroundEnemyIdleState.cs

- 初始化：记录原始位置；无 Animator 时应用"待机色"；停止水平速度。
- 更新：定时 `ScanForPlayer`（射线遮挡），可选"微动"。
- 转换：
  - 发现玩家 -> `Chase`（存在）否则 `Patrol`
  - 待机超时 -> `Patrol`

## 6) GroundEnemyPatrolState.cs

- 简化巡逻：移动时段与暂停时段交替；Rigidbody2D 推进或直接位移。
- 定时 `ScanForPlayer`（遮挡判定）。
- 转换：
  - 发现玩家 -> `Chase`（存在）
  - 巡逻时长结束 -> `Idle`


## 7) GroundEnemyChaseState.cs（已实现）

- 追击玩家：持续朝玩家移动，使用 `chaseSpeed`。
- 墙壁/边缘检测：遇到墙壁或平台边缘时停止追击。
- 视线判定：可配置 `obstacleLayer` 进行遮挡检测。
- 转换：
  - 进入攻击范围 -> `Attack`
  - 目标丢失/超出检测范围 -> `Patrol` 或 `Idle`

## 8) GroundEnemyAttackState.cs（框架）

- 攻击框架：支持攻击判定框、冷却时间、动画事件回调。
- 范围转换逻辑：
  - 玩家在攻击范围内 -> 持续攻击（冷却后重复）
  - 玩家离开攻击范围但在追击范围内 -> `Chase`
  - 玩家离开追击范围 -> `Patrol` 或 `Idle`
- TODO：等待攻击动画完成后接入具体伤害逻辑。

## 9) AirEnemyPatrolState.cs（已实现）

- 飞行巡逻：3D空间自由移动，不受重力影响。
- 多种巡逻模式：`Horizontal`/`Vertical`/`Circular`/`Random`/`Figure8`。
- 边界约束：可配置巡逻区域边界。
- 转换：
  - 发现玩家 -> `Chase`
  - 巡逻时长结束 -> `Idle`

## 10) AirEnemyChaseState.cs（已实现）

- 多种追击模式：`Direct`/`Circling`/`KeepDistance`/`Dive`。
- 障碍物避让：可配置避让距离和层级。
- 转换：
  - 进入攻击范围 -> `Attack`
  - 目标丢失/超出检测范围 -> `Patrol` 或 `Idle`

## 11) AirEnemyAttackState.cs（框架）

- 多种攻击模式：`Dive`（俯冲）/`Ranged`（远程）/`Swoop`（掠过）。
- 范围转换逻辑：与地面攻击状态一致。
- TODO：等待攻击动画和投射物系统完成后接入。

## 12) 易错点与约束

- 忘记在 `RegisterStates()` 注册状态或未在 `enabledStates` 勾选 -> 初始状态切换失败。
- `CreateStateInstance` 未添加对应 case -> 无法创建新状态实例。
- 物理检测层（`groundLayer/wallLayer/obstacleLayer`）配置错误 -> 检测/遮挡失效。
- `GetPlayerTarget()` 需确保场景存在 `Player` Tag，否则将回退使用主摄像机对象作为目标。
- 飞行敌人需设置 `enemyType = FlyingEnemy`，否则会创建地面状态。

## 13) 当前实现进度

| 状态 | 地面敌人 | 飞行敌人 |
|------|----------|----------|
| Idle | ✅ 完成 | ✅ 完成 |
| Patrol | ✅ 完成 | ✅ 完成 |
| Chase | ✅ 完成 | ✅ 完成 |
| Attack | ✅ 框架 | ✅ 框架 |
| Hurt | ❌ 待实现 | ❌ 待实现 |
| Death | ❌ 待实现 | ❌ 待实现 |

## 14) 下一步升级路线

1. 完善攻击状态（接入动画事件与伤害系统）。
2. 实装 `Hurt/Death` 状态。
3. 投射物系统（飞行敌人远程攻击）。

完成以上后，AI 战斗循环达到可玩强度。
